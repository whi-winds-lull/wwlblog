# Kafka

## 1. 定义
### 1.1 传统定义
- 分布式
- 发布订阅
- 消息队列
- 发布订阅分为多种类型，订阅者根据需求选择性订阅

### 1.2 最新定义
- 流平台（存储、计算）

## 2. 消息队列应用场景
1. 缓解峰值流量
2. 解耦系统组件
3. 支持异步通信

## 3. 两种模式
### 3.1 点对点
- 一个生产者，一个消费者
- 一个主题
- 数据会被删除

### 3.2 发布订阅
- 多个生产者
- 多个消费者，相互独立
- 多个主题
- 数据不会被删除

## 4. 架构
1. 生产者
   - 处理100T数据

2. Broker
   - Broker服务器在hadoop102、hadoop103、hadoop104等节点
   - 主题（Topic）用于对数据分类
   - 分区
   - 可靠性和副本
   - Leader和Follower
   - 生产者和消费者只对Leader操作

3. 消费者
   - 消费者之间相互独立
   - 消费者组（一个分区只能由一个消费者消费）

4. Zookeeper
   - 存储Broker信息，如broker.ids
   - Leader选举

# 二、入门

## 1. 安装
- 设置全局唯一的broker.id
- 配置broker.id、log.dirs、zk/kafka
- 启动和停止Kafka，先停止Kafka再停止ZooKeeper
- 使用脚本进行批量启动和停止

## 2. 常用命令行
1. 主题操作使用kafka-topic.sh
2. 生产者使用kafka-console-producer.sh
3. 消费者使用kafka-console-consumer.sh

# 三、生产者

## 1. 原理

## 2. 异步发送API
- 配置连接（bootstrap-server）
- 配置key和value的序列化
- 创建生产者（KafkaProducer）
- 发送数据（send()、send() with Callback）
- 关闭资源

## 3. 同步发送

## 4. 分区
- 默认分区规则
- 自定义分区

## 5. 提高吞吐量
- 调整批次大小
- 调整linger.ms
- 数据压缩
- 增加缓存大小

## 6. 可靠性
- 配置acks参数
- 数据重复处理
- 实现幂等性

## 7. 数据有序
- 单分区内有序
- 多分区有序的处理

## 8. 数据乱序

# 四、Broker

## 1. Zookeeper存储信息
- 存储broker.ids
- Leader信息
- 辅助选举（Controller）

## 2. 工作流程

## 3. 服役
- 服务器准备和计划
- 执行计划
- 验证计划

## 4. 退役

## 5. 副本
- 副本提高可靠性
- Leader和Follower
- ISR（In-Sync Replicas）
- Leader挂了
- Follower挂了
- 手动副本分配
- Leader分区的负载均衡

## 6. 存储机制
- Broker、Topic、Partition
- Log Segment（1GB）
- 稀疏索引（4KB）

## 7. 删除数据
- 数据保留策略
- 删除和压缩

## 8. 高效读写
- 分区
- 稀疏索引
- 顺序读写
- 零拷贝和页缓存

# 五、消费者

## 1. 总体流程

## 2. 消费者组

## 3. 按照主题消费
- 配置连接、反序列化、消费者组ID
- 创建消费者
- 订阅主题
- 消费数据

## 4. 按照分区消费

## 5. 消费者组案例
- 消费者组ID

## 6. 分区分配策略
- Range
- Round Robin
- 粘性

## 7. Offset
- Offset存储
- 自动提交
- 手动提交
- 指定Offset消费
- 按时间消费
- 漏消费和重复消费

## 8. 事务
- 生产端到集群
- 集群到消费者
- 框架

## 9. 数据积压
- 增加分区和消费者个数
- 调整生产参数
- 调整消费端参数

# 六、生产调优和硬件选择
- 日活和日志条数计算
- 服务器台数计算
- 磁盘、内存、CPU和网络选择

# 测试
- 生产者和消费者性能测试
